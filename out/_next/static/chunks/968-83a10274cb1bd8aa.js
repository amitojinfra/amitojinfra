"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[968],{5468:function(e,t,a){a.d(t,{AC:function(){return o},BN:function(){return r},CJ:function(){return d},H8:function(){return n},dP:function(){return i},g8:function(){return l}});let n={PRESENT:"present",ABSENT:"absent",HALF_DAY:"half-day"};Object.values(n);let r=e=>{let t={},a=!0;if(e.employee_id&&""!==e.employee_id.trim()||(t.employee_id="Employee ID is required",a=!1),e.date){let n=new Date(e.date),r=new Date,o=new Date;o.setMonth(o.getMonth()-3),isNaN(n.getTime())?(t.date="Invalid date",a=!1):n>r?(t.date="Cannot mark attendance for future dates",a=!1):n<o&&(t.date="Cannot mark attendance for dates older than 3 months",a=!1)}else t.date="Date is required",a=!1;return e.status?Object.values(n).includes(e.status)||(t.status="Invalid attendance status",a=!1):(t.status="Attendance status is required",a=!1),e.marked_by&&""!==e.marked_by.trim()||(t.marked_by="Marked by information is required",a=!1),e.notes&&e.notes.length>500&&(t.notes="Notes cannot exceed 500 characters",a=!1),{isValid:a,errors:t}},o=e=>{let t=[],a=[],n=!0;return Array.isArray(e)&&0!==e.length?(e.forEach((e,o)=>{let l=r(e);l.isValid?a.push(e):(n=!1,t.push({index:o,employee_id:e.employee_id,errors:l.errors}))}),{isValid:n,errors:t,validRecords:a}):{isValid:!1,errors:["No attendance data provided"],validRecords:[]}},l=e=>{var t,a;let r={employee_id:(null===(t=e.employee_id)||void 0===t?void 0:t.trim())||"",date:e.date||null,status:e.status||n.ABSENT,marked_by:(null===(a=e.marked_by)||void 0===a?void 0:a.trim())||"",marked_at:new Date().toISOString()};return e.notes&&""!==e.notes.trim()&&(r.notes=e.notes.trim()),r},d=(e,t)=>{if(!e||!t)throw Error("Employee ID and date are required to generate attendance ID");let a="string"==typeof t?t:t.toISOString().split("T")[0];return"".concat(e,"_").concat(a)},i=()=>({employee_id:"",date:new Date().toISOString().split("T")[0],status:n.PRESENT,marked_by:"",notes:""})},8968:function(e,t,a){var n=a(5799),r=a(8804),o=a(5468);class l{async markAttendance(e){try{let t=(0,o.BN)(e);if(!t.isValid)throw Error("Validation failed: ".concat(Object.values(t.errors).join(", ")));if(!await r.Z.getEmployee(e.employee_id))throw Error("Employee not found");let a=(0,o.CJ)(e.employee_id,e.date);if(await this.getAttendanceById(a))return await this.updateAttendance(a,e);let l=(0,o.g8)(e);return await n.Z.addDocument(this.collectionName,l),l.attendance_id=a,{id:(await n.Z.addDocument(this.collectionName,l)).id,attendance_id:a,...l}}catch(e){throw console.error("Error marking attendance:",e),e}}async markBulkAttendance(e){try{(0,o.AC)(e);let t={total:e.length,success:0,errors:0,successRecords:[],errorRecords:[]};for(let a=0;a<e.length;a++)try{let n=e[a],r=await this.markAttendance(n);t.success++,t.successRecords.push({index:a,employee_id:n.employee_id,result:r})}catch(n){t.errors++,t.errorRecords.push({index:a,employee_id:e[a].employee_id,error:n.message})}return t}catch(e){throw console.error("Error marking bulk attendance:",e),e}}async getAttendanceById(e){try{let t=await n.Z.getDocuments(this.collectionName,{where:[{field:"attendance_id",operator:"==",value:e}],limit:1});return t.length>0?t[0]:null}catch(e){throw console.error("Error getting attendance by ID:",e),e}}async updateAttendance(e,t){try{let a=(0,o.BN)(t);if(!a.isValid)throw Error("Validation failed: ".concat(Object.values(a.errors).join(", ")));let r=await this.getAttendanceById(e);if(!r)throw Error("Attendance record not found");let l=(0,o.g8)(t);return l.attendance_id=e,l.updated_at=new Date().toISOString(),await n.Z.updateDocument(this.collectionName,r.id,l),{...r,...l}}catch(e){throw console.error("Error updating attendance:",e),e}}async deleteAttendance(e){try{let t=await this.getAttendanceById(e);if(!t)throw Error("Attendance record not found");await n.Z.deleteDocument(this.collectionName,t.id)}catch(e){throw console.error("Error deleting attendance:",e),e}}async getEmployeeAttendance(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let a=await n.Z.getDocuments(this.collectionName,{where:[{field:"employee_id",operator:"==",value:e}]});if(t.dateRange){let{start:e,end:n}=t.dateRange;a=a.filter(t=>{let a=new Date(t.date);return a>=e&&a<=n})}return t.status&&(a=a.filter(e=>e.status===t.status)),a.sort((e,t)=>new Date(t.date)-new Date(e.date)),t.limit&&(a=a.slice(0,t.limit)),a}catch(e){throw console.error("Error getting employee attendance:",e),e}}async getAttendanceByDate(e){try{let t=(await n.Z.getDocuments(this.collectionName)).filter(t=>t.date===e),a=await Promise.all(t.map(async e=>{try{let t=await r.Z.getEmployee(e.employee_id);return{...e,employee_name:t?t.name:"Unknown Employee"}}catch(t){return{...e,employee_name:"Unknown Employee"}}}));return a.sort((e,t)=>(e.employee_name||"").localeCompare(t.employee_name||"")),a}catch(e){throw console.error("Error getting attendance by date:",e),e}}async getAttendanceByDateRange(e,t){try{let a=(await n.Z.getDocuments(this.collectionName)).filter(a=>{let n=new Date(a.date);return n>=e&&n<=t});return a.sort((e,t)=>{let a=new Date(t.date)-new Date(e.date);return 0!==a?a:(e.employee_name||"").localeCompare(t.employee_name||"")}),a}catch(e){throw console.error("Error getting attendance by date range:",e),e}}async getAttendanceStats(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t;let a={total:(t=e.employeeId?await this.getEmployeeAttendance(e.employeeId,{dateRange:e.dateRange}):e.dateRange?await this.getAttendanceByDateRange(e.dateRange.start,e.dateRange.end):await n.Z.getDocuments(this.collectionName)).length,present:0,absent:0,halfDay:0,presentPercent:0,absentPercent:0,halfDayPercent:0,byDate:{},byEmployee:{}};if(0===t.length)return a;return t.forEach(e=>{switch(e.status){case o.H8.PRESENT:a.present++;break;case o.H8.ABSENT:a.absent++;break;case o.H8.HALF_DAY:a.halfDay++}a.byDate[e.date]||(a.byDate[e.date]={present:0,absent:0,halfDay:0,total:0}),a.byDate[e.date]["half-day"===e.status?"halfDay":e.status]++,a.byDate[e.date].total++,a.byEmployee[e.employee_id]||(a.byEmployee[e.employee_id]={present:0,absent:0,halfDay:0,total:0}),a.byEmployee[e.employee_id]["half-day"===e.status?"halfDay":e.status]++,a.byEmployee[e.employee_id].total++}),a.presentPercent=Math.round(a.present/a.total*100),a.absentPercent=Math.round(a.absent/a.total*100),a.halfDayPercent=Math.round(a.halfDay/a.total*100),a}catch(e){throw console.error("Error getting attendance stats:",e),e}}async getEmployeesWithoutAttendance(e){try{let t=await r.Z.getAllEmployees(),a=(await this.getAttendanceByDate(e)).map(e=>e.employee_id);return t.filter(e=>!a.includes(e.id))}catch(e){throw console.error("Error getting employees without attendance:",e),e}}subscribeToAttendance(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{return n.Z.subscribeToCollection(this.collectionName,a=>{let n=a;if(t.employeeId&&(n=n.filter(e=>e.employee_id===t.employeeId)),t.date&&(n=n.filter(e=>e.date===t.date)),t.dateRange){let{start:e,end:a}=t.dateRange;n=n.filter(t=>{let n=new Date(t.date);return n>=e&&n<=a})}n.sort((e,t)=>new Date(t.date)-new Date(e.date)),e(n)})}catch(e){throw console.error("Error subscribing to attendance:",e),e}}constructor(){this.collectionName="attendance"}}let d=new l;t.Z=d}}]);